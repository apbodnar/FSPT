<!DOCTYPE html>
<html>
<head>
<title>Ping Pong Blinn Phong</title>
<script type="text/javascript" src="gl-matrix-min.js"></script>
<style>
  body{ text-align: center; margin: 0; overflow: hidden; }
  canvas{ border: none; }
</style>
<script id="FRAGMENT_SHADER" type="x-shader/x-fragment">
  precision highp float;
  const int sphereCount = 5;
  const float max_t = 100000.0;
  varying vec2 coords;
  uniform int mode;
  uniform vec2 dims;
  uniform vec3 eye;
  struct Sphere {
    vec3 pos;
    vec3 attrs;
    vec3 color;
  };
  struct Hit{
    float t;
    vec3 color;
    vec3 pos;
    vec3 dir;
    vec3 normal;
  };
  uniform vec3 spherePositions[sphereCount];
  uniform vec3 sphereAttrs[sphereCount];
  uniform vec3 sphereColors[sphereCount];
  uniform sampler2D tex;

  float checkSphereCollision(vec3 dir, vec3 origin,vec3 center,float radius){
    float scalar = dot(dir,origin - center);
    float dist = distance(origin, center);
    float squared = (scalar * scalar) - (dist * dist) + (radius * radius);
    return squared >= 0.0 ? -scalar - sqrt(squared) : max_t;
  }

  Hit getDepth(vec3 dir, vec3 origin){
    float t = max_t;
    vec3 color = vec3(0,0,0);
    vec3 pos;
    for(int i=0; i<sphereCount; i++){
      Sphere s = Sphere(spherePositions[i],sphereAttrs[i],sphereColors[i]);
      vec3 pos = s.pos;
      float radius = s.attrs.r;
      float nt = t;
      t = min(checkSphereCollision(dir,origin,pos,radius),t);
      if(t < nt){
        color = s.color;
        pos = s.pos;
      }
    }
    vec3 p = dir*t;
    vec3 normal = normalize(p - pos);
    vec3 ref = reflect(dir, normal);
    return Hit(t,color,p,ref,normal);
  }

  void main(void) {
    vec3 origin = vec3(coords.x*dims.x/dims.y,coords.y,0);
    vec3 dir = normalize(origin - eye);
    Hit result = getDepth(dir, origin);
    if(result.t < max_t){
      gl_FragColor = vec4(result.color ,1.0);
    } else {
      gl_FragColor = vec4(0.0,0.0,0.0,1.0);
    }
    /*
    if(mode == 0){
      gl_FragColor = vec4(vec3(abs(coords),1.0) - texture2D(tex,coords*0.5 + 0.5).rgb,1);
    } else {
      gl_FragColor = texture2D(tex,coords*0.5 + 0.5);
    }
    */
  }
</script>

<script id="VERTEX_SHADER" type="x-shader/x-vertex">
  precision highp float;
  attribute vec3 corner;
  varying vec2 coords;
  void main(void) {
    coords = corner.xy;
    gl_Position = vec4(corner, 1.0);
  }
</script>
<script src="fspt.js" type="text/javascript"></script>
</head>


<body onload="webGLStart();">
  <canvas id="trace" style="border: none;"></canvas>
</body>

</html>
